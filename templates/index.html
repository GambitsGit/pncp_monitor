<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>PNCP Monitor - LicitaÃ§Ãµes 3D</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { padding: 20px; }
  .progress { height: 28px; }
  .status-text { font-size: 0.95rem; color: #555; }
  .badge-aberta { background: #28a745; }
  .badge-encerrada { background: #dc3545; }
</style>
</head>
<body>

<div class="container">

  <h2 class="mb-4">ðŸ“Š PNCP Monitor - LicitaÃ§Ãµes de ImpressÃ£o 3D</h2>

  <!-- CONTROLES -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">PerÃ­odo (dias)</label>
          <input type="number" id="dias" class="form-control" value="365">
        </div>

        <div class="col-md-3">
          <label class="form-label">SituaÃ§Ã£o</label>
          <select id="filtroSituacao" class="form-select">
            <option value="">Todas</option>
            <option value="aberta">Abertas</option>
            <option value="encerrada">Encerradas</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Busca</label>
          <input type="text" id="busca" class="form-control" placeholder="Objeto ou Ã³rgÃ£o...">
        </div>

        <div class="col-md-2 d-grid">
          <button class="btn btn-primary" onclick="iniciarColeta()">ðŸ”„ Coletar</button>
        </div>
      </div>

      <!-- PROGRESSO -->
      <div class="mt-4">
        <div class="progress">
          <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
        </div>
        <div class="status-text mt-2" id="status-text">Aguardando...</div>
      </div>
    </div>
  </div>

  <!-- TABELA -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">ðŸ“‹ LicitaÃ§Ãµes Encontradas</h5>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ã“rgÃ£o</th>
              <th>Objeto</th>
              <th>Valor</th>
              <th>PublicaÃ§Ã£o</th>
              <th>SituaÃ§Ã£o</th>
            </tr>
          </thead>
          <tbody id="tabela-licitacoes"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
function iniciarColeta() {
  const dias = parseInt(document.getElementById("dias").value || "365");

  fetch("/api/coletar", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ dias: dias })
  });

  atualizarStatus();
}

function atualizarStatus() {
  fetch("/api/coleta/status")
    .then(r => r.json())
    .then(s => {
      const bar = document.getElementById("progress-bar");
      const text = document.getElementById("status-text");

      text.innerText = s.mensagem + 
        ` | UF: ${s.uf_atual || "-"} | PÃ¡gina: ${s.pagina} | Processadas: ${s.total_processadas} | Relevantes: ${s.relevantes}`;

      // Progresso estimado (fake UX): assume atÃ© 20 pÃ¡ginas por UF e 27 UFs
      let progresso = 0;
      if (s.rodando) {
        const totalPaginasEstimadas = 27 * 20;
        const atual = ((UFS_INDEX[s.uf_atual] || 0) * 20) + s.pagina;
        progresso = Math.min((atual / totalPaginasEstimadas) * 100, 99);
      } else {
        progresso = 100;
      }

      bar.style.width = progresso.toFixed(1) + "%";
      bar.innerText = progresso.toFixed(0) + "%";

      if (s.rodando) {
        setTimeout(atualizarStatus, 2000);
      } else {
        carregarLicitacoes();
      }
    })
    .catch(() => {
      setTimeout(atualizarStatus, 3000);
    });
}

// Mapa de UFs para cÃ¡lculo de progresso
const UFS_INDEX = {
  "AC":0,"AL":1,"AP":2,"AM":3,"BA":4,"CE":5,"DF":6,"ES":7,"GO":8,"MA":9,"MT":10,"MS":11,"MG":12,
  "PA":13,"PB":14,"PR":15,"PE":16,"PI":17,"RJ":18,"RN":19,"RS":20,"RO":21,"RR":22,"SC":23,"SP":24,"SE":25,"TO":26
};

function carregarLicitacoes() {
  const situacao = document.getElementById("filtroSituacao").value;
  const busca = document.getElementById("busca").value;

  let url = "/api/licitacoes?";
  if (situacao) url += "situacao=" + encodeURIComponent(situacao) + "&";
  if (busca) url += "busca=" + encodeURIComponent(busca);

  fetch(url)
    .then(r => r.json())
    .then(d => {
      const tbody = document.getElementById("tabela-licitacoes");
      tbody.innerHTML = "";

      d.licitacoes.forEach(l => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${l.id}</td>
          <td>${l.orgao_nome || ""}</td>
          <td>${l.objeto_compra || ""}</td>
          <td>R$ ${(l.valor_total || 0).toLocaleString("pt-BR")}</td>
          <td>${l.data_publicacao || ""}</td>
          <td>
            <span class="badge ${l.situacao === "aberta" ? "badge-aberta" : "badge-encerrada"}">
              ${l.situacao}
            </span>
          </td>
        `;

        tbody.appendChild(tr);
      });
    });
}

// Recarrega quando mudar filtros
document.getElementById("filtroSituacao").addEventListener("change", carregarLicitacoes);
document.getElementById("busca").addEventListener("input", () => {
  clearTimeout(window._buscaTimer);
  window._buscaTimer = setTimeout(carregarLicitacoes, 400);
});

// Carrega ao abrir
carregarLicitacoes();
</script>

</body>
</html>
